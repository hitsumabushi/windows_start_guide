# Active Directory
## Active Directoryでできること
1. 認証/承認の管理
2. SSO
3. デスクトップ環境の統一 (グループポリシーの利用)
4. セキュリティ更新プログラムの配布 (WSUS)
5. 監査記録 (監査機能の利用)
    - ファイルサーバー上のファイルに対するアクセス記録を取得できる
6. AD BAによるライセンス管理

### 最近の注目の機能
1. Workplace Join
    - 割と注目されている機能の1つ
    - ドメインに参加できないiOSなどのデバイスに対して、デバイス認証に基づいてリソースへのアクセスを提供する
        - Windows 7/8のProより下のエディションなども"参加"はできない
        - Windows 8は、"参加"できないが、Workplace Joinによって、"登録"はできる
    - AD FSに加え、DRS(Device Registration Service)が必要
2. 多要素認証
    - AD FSで多要素認証が使えるようになった
3. Dynamic Access Control
    - ユーザーなどのプロパティを元にアクセス権を自動設定する
4. Direct Accessオフラインドメイン参加
    - Direct Access 環境がセットアップされていると、インターネット経由でドメインに参加できる

### Active Directory のサービス
- AD DS
    - Active Directory ドメインサービス
    - IDの集約・認証
- AD LDS
    - LDAP機能を担当
- AD CS
    - Active Directory 証明書サービス
    - 証明書の発行・管理
- AD FS
    - Active Directory フェデレーションサービス
    - 異なる認証基盤での連携を行う
    - Azureとの連携を行うなど
- AD RMS
    - Active Directory Rights Managementサービス
    - コンテンツの保護を行うサービス
    - Microsoft Officeの文書を暗号化できる
    - 利用には、RMS CAL ライセンスが必要
- AD BA
    - Active Directory-Based Activation
    - Windows Server 2012以降と、Windows 8以降のライセンス認証をADで行う

## Active Directoryの概念
### 基本概念
- ディレクトリデータベース
    - スキーマ情報、構成情報、ドメイン情報を保持しているもの
    - ドメイン情報はドメインごとに異なるが、そのほかは、フォレスト単位
- 信頼関係
    - 信頼関係にあるドメイン(もしくは、フォレスト)は、お互いの共有フォルダや、共有プリンタなどのリソースにアクセスできる
    - フォレスト内に複数のドメインがある場合に、認証を高速に行う必要がある場合、ショートカットの信頼関係を結ぶ
- グローバルカタログ
    - フォレスト全体のディレクトリ全体における、目次のようなデータ
    - フォレスト内のドメインにあるすべてのオブジェクト名と、一部の属性を保持
    - グローバルカタログを保持するサーバーをグローバルカタログサーバーという。複数作成しておく
- フォレスト
    - ADの最も大きな操作単位
    - グローバルカタログを共有する範囲
    - 複数のドメインツリーを含み、その中の各々のドメインは互いに信頼関係が成立
    - 管理者が異なる場合、スキーマを分ける場合などに分割される
- ドメインツリー
    - ドメインの親子関係を表現した木構造
    - 子ドメイン名は親ドメイン名を継承する
    - ドメインツリーに参加するドメインは互いに信頼関係が成立
- ドメイン
    - 同じディレクトリデータベースを共有する範囲
    - アカウント, ポリシーなどを管理する基本的な単位
    - ドメイン名には、DNS名やNetBIOS名を利用可能
    - 拠点が離れている場合や、異なる言語のドメインコントローラを利用する場合、アカウントが組織ごとに個別に管理されている場合に分割する
- ドメインコントローラ
    - ディレクトリデータベースを持つサーバー
    - 各ドメインに必ず1台以上必要
    - RODC(Read Only Domain Controller)と呼ばれるものも作成できる

### 機能レベル
機能レベルは、OSのバージョンによって表現され、
機能レベルを利用するには、すべてのドメインコントローラをその機能が利用できるバージョンのOSに更新する必要がある。
機能レベルには、フォレストの機能レベルと、ドメインの機能レベルの2種類が存在する。

### ディレクトリデータベースの複製
ドメイン内の複製では、スキーマ/構成/ドメイン情報をそのまま複製するが、
マルチドメインでの複製では、スキーマ/構成は複製し、ドメインについては、次ドメインのものを格納していくことになる。

### サイト
サイトを分割しておくと、遅延の大きい拠点との通信を減らしたり良い感じにしてくれる(サイトリンク)。

### その他のActive Directoryのコンポーネント
- グローバルカタログサーバー
    - 複数のグローバルカタログサーバーを作成し、冗長性を確保する
- 操作マスター (FSMO ロール)
    - デフォルトでは1台目のドメインコントローラが5つのロールを全て持つ
    - マルチドメイン構成では、インフラストラクチャマスターとグローバルカタログサーバーを共存できない

        | 役割              | 単位            | 機能                      |
        |-------------------|-----------------|---------------------------|
        | スキーママスター  | フォレストに1つ | スキーマを管理するマスター |
        | ドメイン名前付けマスター | フォレストに1つ | ドメインの追加・削除を行う際のマスター |
        | PDC エミュレータ  | ドメインに1つ   | Windows NT時代のOSのために必要。後述するNTPの時刻合わせでも重要 |
        | RIDマスター       | ドメインに1つ   | RID(Relative ID)プールをドメインコントローラに割り当てる |
        | インフラストラクチャマスター | ドメインに1つ | ドメインのオブジェクトインスタンスの整合性を保証。自ドメインのオブジェクトから他ドメインのオブジェクトへの参照の更新など |
- DNSサーバー
    - Active DirectoryのDNSサーバーを利用することで、DNSサーバーのデータをディレクトリ複製に含められる
    - レコードのアクセス権の設定
    - SRVレコードの動的更新
- NTPサーバー
    - PDCエミュレータの機能を持つドメインコントローラがNTPサーバーとして動作
    - 各ドメインコントローラは、PDCエミュレータの機能を持つドメインコントローラの時刻に同期
    - ドメインに参加したドメインコントローラの時刻に同期
    - つまり、特にPDCエミュレータとなるWindows Serverの時刻設定には注意しよう

### OU (Organization Unit)について
ユーザー, グループやコンピュータなどのリソースをオブジェクトと呼ぶ。これらのリソースをまとめて管理するためのオブジェクトがOU。
このOUは、実際には、Active Directoryのオブジェクトを格納する構造体である、コンテナの一種。

コンテナの種類は、以下の通り。
1. OU
    - 管理者が自由に作成可能
    - グループポリシーをリンクできる
    - 下位にOUを作成して階層構造にできる
    - 特定のユーザ/グループに管理を委任できる
2. デフォルトのコンテナ
    - ユーザーでは作成できない
    - グループポリシーもリンクできない
    - 下位にOUを作成して階層構造することができない

デフォルト設定では、ユーザオブジェクトはUsersコンテナ、コンピュータオブジェクトはComputersコンテナに格納されるなどする。
できる限り、ユーザオブジェクト用OUなどを作成し、作成したOUに格納されるように設定を変更する方が柔軟な設計が可能になる。
ただし、ドメインコントローラだけは、**もともとの "Domain Controllers" OUから移動しない**ことが推奨。(Default Domain Controllers Policy というグループポリシーが適用済みのため。)

#### OUの設計について
- 分けるべきもの
    - オブジェクトの種類: ユーザ/コンピュータ/グループ/サーバ...
    - 管理者がことなる部分
- 分けるべきでないもの
    - 変更が頻繁な(部門など)組織単位
        - 分社単位など、変更の少ない単位で分けるのはあり。この場合、各組織単位で分けた中で、一般的なOUを作成する

#### PowerShell: OUの追加・削除

```Powershell
# OU追加
New-ADOrganizationalUnit -Name "01ユーザ" -Path "DC=org01,DC=itd-corp,DC=JP"

# OU削除
Remove-ADOrganizationalUnit -Identity "OU=01ユーザ,DC=org01,DC=itd-corp,DC=JP" -Confirm:$false

# デフォルトコンテナの変更
redirusr "OU=01ユーザ,DC=org01,DC=itd-corp,DC=JP"
redircmp "OU=03コンピュータ,DC=org01,DC=itd-corp,DC=JP"
```

### サービスアカウントの管理
サービスを実行するアカウントとして、独自に生成したユーザーで行う場合、アカウント管理が煩雑になりがち。
Windows Server 2008までには、MSA(Managed Service Account)という機能があり、パスワード更新の処理が自動化されていたが、複数のコンピュータでアカウントを共有できなかった。
Windows Server 2012から、**gMSA(group Managed Service Account)** という機能へ拡張され、サービスアカウントの認証を統一できるようになった。

#### gMSAの展開手順

**TODO: 手順の追加**
1. KDSルートキー作成
2. gMSAの作成
3. gMSAのサービスへの割り当て

### グループポリシーとGPO(Group Policy Object)
#### グループポリシー
ドメインに参加しているクライアントコンピューターの環境設定やセキュリティ設定を管理する機能。
#### GPO
クライアントコンピューターに適用するポリシーをまとめたオブジェクト。
コンピューターごとに定義する**ローカルGPO**というものもあるが、以後単にGPOと言った場合には、Active DirectoryベースのGPOを指すことにする。

##### GPOの適用と継承関係
1. GPOはサイトやドメインなどのコンテナに割り当てる(これを*リンクする*という)
      - リンクされると、そのコンテナに属する全てのクライアントコンピューターやユーザーにGPOが適用される
2. GPOは継承される
      - あるコンテナにGPOをリンクすると、下位のコンテナにもGPOが適用される
      - あるコンテナに適用されるGPOは以下で決まる(継承関係ではよく見る普通のやつ)
          - 『継承ツリーの中で、自分より上位で、自分に最も近いGPO』


# Windows Serverでのサービスのインストール

# クラスタリング

# 監視

# セキュリティ

# Windows 自動化について
## PowerShell
- 初心者用リソース
    - [Windows PowerShell Basics](https://technet.microsoft.com/ja-jp/library/dd347730.aspx)
    - [Windows PowerShell: スクリプト作成の短期集中講座](https://technet.microsoft.com/ja-jp/magazine/hh551144.aspx)
- 管理用の情報
    - [Windows Server 2012R2サーバーの管理性および自動化 - ホワイトペーパー](http://download.microsoft.com/download/A/8/B/A8BF66E5-B315-49D0-8EBE-02263B221DCC/Windows_Server_2012_R2_Server_Management_and_Automation_White_Paper.pdf)
    - [Windows Server 2012R2サーバーの管理性および自動化](http://download.microsoft.com/download/B/2/0/B20A660F-787F-4C17-8CE6-35E9789E2CB1/Windows-Server-2012-R2-Server-Management-and-Automation.pdf)
- コマンドリファレンス
    + [Windows and Windows Server Automation with Windows PowerShell](https://technet.microsoft.com/ja-jp/library/dn249523.aspx)

## AIK・sysprepについて
### できること/できないこと
### 使い方
